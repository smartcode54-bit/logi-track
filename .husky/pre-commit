#!/bin/sh

# Check if .vibe-rules.md was modified in this commit
if git diff --cached --name-only | grep -q ".vibe-rules.md"; then
  echo "âœ… .vibe-rules.md is updated. Proceeding with commit..."
  exit 0
fi

# Get the date and changed files
TODAY=$(date +%Y-%m-%d)
CHANGED_FILES=$(git diff --cached --name-only | head -3 | tr '\n' ', ' | sed 's/,$//')

# Auto-generate description based on changed files
if echo "$CHANGED_FILES" | grep -q "maintenance"; then
  DESCRIPTION="Maintenance page updates"
elif echo "$CHANGED_FILES" | grep -q "renew"; then
  DESCRIPTION="Renewal workflow updates"
elif echo "$CHANGED_FILES" | grep -q "trucks"; then
  DESCRIPTION="Truck management updates"
elif echo "$CHANGED_FILES" | grep -q "husky"; then
  DESCRIPTION="Git hooks updates"
else
  DESCRIPTION="Code updates"
fi

echo ""
echo "ðŸ“ Auto-updating .vibe-rules.md changelog..."
echo "   Entry: | $TODAY | $DESCRIPTION | $CHANGED_FILES |"

# Create temp file with new entry - simpler approach for Windows
ENTRY="| $TODAY | $DESCRIPTION | $CHANGED_FILES |"

# Use sed to append after the last dated changelog line
sed -i "/^| 202.*|$/a\\$ENTRY" .vibe-rules.md 2>/dev/null || {
  # Fallback: Use PowerShell if sed fails
  powershell -NoProfile -Command "
    \$file = '.vibe-rules.md'
    \$content = Get-Content \$file
    \$entry = '| $TODAY | $DESCRIPTION | $CHANGED_FILES |'
    \$output = @()
    \$inserted = \$false
    for (\$i = 0; \$i -lt \$content.Length; \$i++) {
      \$output += \$content[\$i]
      if (-not \$inserted -and \$content[\$i] -match '^\\| 202' -and (\$i+1 -ge \$content.Length -or \$content[\$i+1] -notmatch '^\\| 202')) {
        \$output += \$entry
        \$inserted = \$true
      }
    }
    \$output | Set-Content \$file
  "
}

# Stage the updated file
git add .vibe-rules.md

echo "âœ… Changelog auto-updated and staged!"
