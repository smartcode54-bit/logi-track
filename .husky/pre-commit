#!/bin/sh

# Check if .vibe-rules.md was modified in this commit
if git diff --cached --name-only | grep -q ".vibe-rules.md"; then
  echo "‚úÖ .vibe-rules.md is updated. Proceeding with commit..."
  exit 0
fi

# Get the commit message from the staged commit (if using commit-msg hook)
# For pre-commit, we'll use a simple auto-description based on changed files
TODAY=$(date +%Y-%m-%d)

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only | head -3 | tr '\n' ', ' | sed 's/,$//')

# Auto-generate description based on changed files
if echo "$CHANGED_FILES" | grep -q "maintenance"; then
  DESCRIPTION="Maintenance page updates"
elif echo "$CHANGED_FILES" | grep -q "renew"; then
  DESCRIPTION="Renewal workflow updates"
elif echo "$CHANGED_FILES" | grep -q "trucks"; then
  DESCRIPTION="Truck management updates"
else
  DESCRIPTION="Code updates"
fi

# Create the changelog entry
ENTRY="| $TODAY | $DESCRIPTION | $CHANGED_FILES |"

echo ""
echo "üìù Auto-updating .vibe-rules.md changelog..."
echo "   Entry: $ENTRY"

# Find the last changelog entry line and append after it
powershell -Command "
  \$content = Get-Content '.vibe-rules.md' -Raw
  \$entry = '| $TODAY | $DESCRIPTION | $CHANGED_FILES |'
  
  # Find position after last dated entry (lines starting with | 202)
  \$lines = \$content -split \"`r?`n\"
  \$lastEntryIndex = -1
  for (\$i = 0; \$i -lt \$lines.Length; \$i++) {
    if (\$lines[\$i] -match '^\| 202') {
      \$lastEntryIndex = \$i
    }
  }
  
  if (\$lastEntryIndex -ge 0) {
    \$newLines = @()
    for (\$i = 0; \$i -lt \$lines.Length; \$i++) {
      \$newLines += \$lines[\$i]
      if (\$i -eq \$lastEntryIndex) {
        \$newLines += \$entry
      }
    }
    \$newLines -join \"`r`n\" | Set-Content '.vibe-rules.md' -NoNewline
  }
"

# Stage the updated file
git add .vibe-rules.md

echo "‚úÖ Changelog auto-updated and staged!"
