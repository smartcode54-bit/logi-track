# Vibe Rules - LogiTrack Project

This document captures project direction, design decisions, and rules to follow when making changes.

---

## ‚ö†Ô∏è MANDATORY WORKFLOW

> **IMPORTANT:** This file MUST be updated immediately before any:
> - `git commit` / `git push`
> - Deployment to any environment
>
> **What to update:**
> 1. Add new entries to the **Change Log** table
> 2. Update **Confirmed Patterns** if new patterns were established
> 3. Update **Pending Decisions** if new questions arose
> 4. Update any section that was affected by the changes

---

## üéØ Project Overview

**LogiTrack** - A logistics management platform for tracking trucks, drivers, subcontractors, and assignments.

---

## üé® UI/UX Guidelines

### Design System
- Use **shadcn/ui** components from `@/components/ui/`
- Follow dark mode support patterns already in the codebase
- Use **Tailwind CSS** for styling
- Icons from **Lucide React**

### Form Patterns
- Multi-step wizard forms should have:
  - Sticky header with step indicator
  - Sidebar navigation for steps (desktop)
  - Sticky footer with Back/Next buttons
  - Progress indicator showing current step

### Color Conventions
- Primary actions: `bg-blue-600 hover:bg-blue-700`
- Success states: Green tones (`bg-green-*`)
- Warning states: Orange/Yellow tones
- Error states: Red tones (`bg-destructive`)

### üåê Translation (MANDATORY)

> **‚ö†Ô∏è ALL UI text MUST be translated. No hardcoded strings allowed.**

**When creating or updating any UI component:**

1. **Import the language hook:**
   ```tsx
   import { useLanguage } from "@/context/language";
   const { t } = useLanguage();
   ```

2. **Use translation keys instead of hardcoded text:**
   ```tsx
   // ‚ùå WRONG
   <Button>Save Changes</Button>
   
   // ‚úÖ CORRECT  
   <Button>{t("saveChanges")}</Button>
   ```

3. **Add translations to `context/language.tsx`:**
   ```tsx
   saveChanges: {
     en: "Save Changes",
     th: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á",
   },
   ```

4. **Checklist before commit:**
   - [ ] All visible text uses `t("key")` pattern
   - [ ] All new keys added to `context/language.tsx`
   - [ ] Both `en` and `th` translations provided

---

## üìÅ Project Structure

```
app/
‚îú‚îÄ‚îÄ admin/           # Admin dashboard pages
‚îÇ   ‚îú‚îÄ‚îÄ trucks/      # Truck management
‚îÇ   ‚îú‚îÄ‚îÄ drivers/     # Driver management  
‚îÇ   ‚îú‚îÄ‚îÄ subcontractors/  # Subcontractor management
‚îÇ   ‚îî‚îÄ‚îÄ truck-assignment/ # Assignment management
‚îú‚îÄ‚îÄ join-network/    # Public subcontractor application
‚îî‚îÄ‚îÄ api/             # API routes

components/
‚îú‚îÄ‚îÄ ui/              # Reusable UI components (shadcn)
‚îú‚îÄ‚îÄ landing/         # Landing page components
‚îî‚îÄ‚îÄ *.tsx            # Shared components

validate/            # Zod schemas for form validation
context/             # React contexts (language, etc.)
lib/                 # Utilities and helpers
```

---

## üîß Technical Decisions

### Form Validation
- Use **Zod** schemas in `validate/` directory
- Integrate with **react-hook-form** via `@hookform/resolvers`

### State Management
- React Context for global state (language, auth)
- React Hook Form for form state
- Local state (`useState`) for component-level state

### Data Fetching
- Server Actions for mutations
- Client-side fetching where needed

### üóÑÔ∏è Database Collections (MANDATORY)

> **‚ö†Ô∏è ALL collection names MUST use const variables. No string literals allowed.**

**Define collection names in a constants file:**
```typescript
// lib/collections.ts
export const COLLECTIONS = {
  USERS: "users",
  TRUCKS: "trucks",
  DRIVERS: "drivers",
  SUBCONTRACTORS: "subcontractors",
  ASSIGNMENTS: "assignments",
} as const;
```

**Usage:**
```typescript
// ‚ùå WRONG - hardcoded string
const docRef = doc(db, "users", id);
const collRef = collection(db, "subcontractors");

// ‚úÖ CORRECT - use const variable
import { COLLECTIONS } from "@/lib/collections";
const docRef = doc(db, COLLECTIONS.USERS, id);
const collRef = collection(db, COLLECTIONS.SUBCONTRACTORS);
```

**Benefits:**
- Typo prevention with TypeScript autocomplete
- Easy refactoring if collection names change
- Single source of truth for all collection names

---

## üö¶ Compliance & Thresholds (MANDATORY)

> **‚ö†Ô∏è All compliance logic MUST follow these standard thresholds.**

### Warning Levels
1. **Overdue (Red)**
   - Date: Past due (< 0 days)
   - Mileage: Over limit (< 0 km remaining)
   
2. **Due Soon / Expiring (Orange)**
   - Date: 0 - 30 days remaining
   - Mileage: 0 - 2,000 km remaining (User specified)

3. **Incoming (Blue)**
   - Date: 31 - 60 days remaining
   - Mileage: 2,001 - 5,000 km remaining

### Implementation Rule
- Use these constants in both **filtering logic** (List Pages) and **status calculation** (Cards/Widgets).
- Do not hardcode numbers like `1000` or `30` in multiple places; define them once or follow this standard strictly.

---

## üõ°Ô∏è Schema Validation Rules

### Dependent Fields
> **‚ö†Ô∏è Validation availability MUST depend on `ownerType` or similar discriminators.**

Use `superRefine` to enforce rules that standard Zod shapes cannot catch:

```typescript
// ‚úÖ CORRECT - Enforce fields only for "own" fleet
.superRefine((data, ctx) => {
  if (data.ownerType === "own") {
    if (!data.taxExpiryDate) {
      ctx.addIssue({ code: z.ZodIssueCode.custom, message: "Required for own fleet", path: ["taxExpiryDate"] });
    }
  }
});
```

---

## üèÜ Best Practices

### Code Quality
- **TypeScript strict mode** - Always use proper types, avoid `any`
- **Consistent naming** - Use camelCase for variables/functions, PascalCase for components
- **Single responsibility** - Each function/component should do one thing well
- **DRY principle** - Extract repeated logic into reusable hooks/utilities
- **Error handling** - Always wrap async operations in try/catch with proper error messages

### Component Patterns
```tsx
// ‚úÖ GOOD - Early returns for loading/error states
if (loading) return <Loader2 className="animate-spin" />;
if (error) return <ErrorMessage message={error} />;
return <MainContent data={data} />;
```

### File Organization
- Keep files under 300 lines when possible
- Extract large components into separate files
- Group related functionality in directories

---

## ‚ö° High Performance

### React Optimization
- **Memoization** - Use `useMemo` for expensive calculations, `useCallback` for callbacks passed to children
- **Lazy loading** - Use `dynamic()` for heavy components not needed on initial load
- **Virtualization** - Use virtual lists for large data sets (100+ items)

### Firestore Optimization
```typescript
// ‚úÖ GOOD - Limit queries, use pagination
const q = query(collection(db, COLLECTIONS.TRUCKS), 
  orderBy("createdAt", "desc"), 
  limit(20)
);

// ‚úÖ GOOD - Use compound indexes for complex queries
// ‚úÖ GOOD - Subscribe only when needed, unsubscribe on cleanup
useEffect(() => {
  const unsubscribe = onSnapshot(q, callback);
  return () => unsubscribe();
}, []);
```

### Bundle Size
- Import specific icons: `import { Loader2 } from "lucide-react"` not `import * as Icons`
- Use tree-shakeable imports
- Analyze bundle with `npm run build` and review output

### Image Optimization
- Use Next.js `<Image>` component for automatic optimization
- Compress images before upload
- Use WebP format when possible

---

---

## üöÄ Deployment & Routing Standards (MANDATORY)

### Static Export vs Dynamic Routes
> **‚ö†Ô∏è CRITICAL: Firebase Hosting + Next.js Static Export Issue**

- **Problem**: Accessing dynamic routes (e.g., `/admin/trucks/[id]`) directly on Firebase Hosting often triggers a 404/redirect loop because the specific HTML file doesn't exist at the root level.
- **Solution**: Use **Query Parameters** for detail views that fetch data client-side.
  - ‚ùå **Avoid**: `router.push('/admin/trucks/' + id)`
  - ‚úÖ **Use**: `router.push('/admin/trucks/view?id=' + id)`

### File Hygiene & Duplication
> **‚ö†Ô∏è NEVER leave duplicate or dead files in the codebase.**

- **Refactoring Rule**: If you move logic from `[id]/page.tsx` to `view/page.tsx`, you **MUST DELETE** the old `[id]` files immediately.
- **Why**: Having same-named components (`TruckPreviewClient`) in multiple locations causes:
  1. Build errors (Module resolution conflicts)
  2. Developer confusion (Editing the wrong file)
  3. "Ghost" bugs (Changes not reflecting)

---

## üîí High Security

### Authentication & Authorization
- **Never trust client-side** - Always validate permissions server-side
- **Use Firebase Security Rules** - Restrict database access by role
- **Token validation** - Verify auth tokens on all API routes

### Input Validation
```typescript
// ‚úÖ ALWAYS validate with Zod before saving to database
const result = schema.safeParse(data);
if (!result.success) {
  throw new Error("Validation failed");
}
```

### Sensitive Data
- **Never expose credentials** - Use environment variables
- **Never log sensitive data** - No passwords, tokens, or PII in console.log
- **Sanitize user input** - Prevent XSS, SQL injection, NoSQL injection

### Firebase Security Rules (Example)
```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Admin-only collections
    match /trucks/{truckId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == 'admin';
    }
  }
}
```

### Checklist Before Deploy
- [ ] No hardcoded API keys or secrets
- [ ] Firebase Security Rules reviewed
- [ ] All user inputs validated with Zod
- [ ] Error messages don't expose internal details
- [ ] Authentication required for protected routes

---

## üè¢ Multi-Tenancy Pattern (MANDATORY)

> **‚ö†Ô∏è ALL major entities MUST include `ownerType` and `subcontractorId` fields for proper data isolation.**

### Required Fields
```typescript
interface TenantAwareEntity {
  // Ownership identification
  ownerType: "own" | "subcontractor";  // Who owns this record
  subcontractorId?: string;             // Required when ownerType === "subcontractor"
  
  // ... other fields
}
```

### Usage Example
```typescript
// Creating a truck for company fleet
const companyTruck = {
  ownerType: "own",
  subcontractorId: undefined,  // Not needed for company-owned
  licensePlate: "ABC-1234",
  // ...
};

// Creating a truck for a subcontractor
const partnerTruck = {
  ownerType: "subcontractor",
  subcontractorId: "sub_abc123",  // REQUIRED
  licensePlate: "XYZ-5678",
  // ...
};
```

### Query Patterns
```typescript
// ‚úÖ Fetch only company-owned trucks
const q = query(
  collection(db, COLLECTIONS.TRUCKS),
  where("ownerType", "==", "own")
);

// ‚úÖ Fetch trucks for specific subcontractor
const q = query(
  collection(db, COLLECTIONS.TRUCKS),
  where("ownerType", "==", "subcontractor"),
  where("subcontractorId", "==", subId)
);
```

### Entities Requiring Multi-Tenancy
- ‚úÖ Trucks (`ownerType`, `subcontractorId`)
- ‚úÖ Drivers (if assigned to subcontractor)
- ‚úÖ Assignments (inherit from truck/driver)
- ‚ö†Ô∏è New entities should follow this pattern

---

## üìú Immutable Logs Pattern (statusHistory)

> **‚ö†Ô∏è Status changes MUST be logged immutably for audit trail.**

### Implementation
```typescript
interface StatusHistoryEntry {
  status: string;           // The new status
  changedAt: Timestamp;     // When the change occurred
  changedBy: string;        // User ID who made the change
  changedByName?: string;   // Display name for convenience
  reason?: string;          // Optional reason for change
  previousStatus?: string;  // What it was before
}

interface EntityWithHistory {
  status: string;                    // Current status
  statusHistory: StatusHistoryEntry[]; // Immutable log (append-only)
}
```

### Usage Example
```typescript
// When updating status, APPEND to history (never delete/modify)
const newHistoryEntry: StatusHistoryEntry = {
  status: "active",
  changedAt: Timestamp.now(),
  changedBy: currentUser.uid,
  changedByName: currentUser.displayName,
  previousStatus: truck.status,
  reason: "Annual inspection passed"
};

await updateDoc(truckRef, {
  status: "active",
  statusHistory: arrayUnion(newHistoryEntry),  // Append only!
  updatedAt: serverTimestamp()
});
```

### Rules
- ‚ùå **NEVER** delete entries from `statusHistory`
- ‚ùå **NEVER** modify existing entries
- ‚úÖ **ONLY** append new entries using `arrayUnion()`
- ‚úÖ Include `changedBy` for accountability
- ‚úÖ Include `previousStatus` for easy auditing

### Entities Requiring statusHistory
- ‚úÖ Trucks (status changes: active ‚Üí maintenance ‚Üí inactive)
- ‚úÖ Subcontractors (status changes: pending ‚Üí active ‚Üí suspended)
- ‚úÖ Assignments (status changes: active ‚Üí completed ‚Üí cancelled)
- ‚úÖ Users (status changes: active ‚Üí disabled)

---

## ü§ñ AI Self-Correction Checklist

> **Before completing any code generation, verify the following:**

### 1. Translation Check
- [ ] All UI text uses `t("key")` pattern
- [ ] No hardcoded English/Thai strings in JSX
- [ ] New translation keys added to `context/language.tsx`

### 2. Collection Names Check
- [ ] All Firestore collections use `COLLECTIONS.*` constants
- [ ] No hardcoded collection strings like `"users"` or `"trucks"`

### 3. Multi-Tenancy Check
- [ ] New entities include `ownerType` field
- [ ] `subcontractorId` included where applicable
- [ ] Queries filter by ownership when appropriate

### 4. Immutable Logs Check
- [ ] Status changes append to `statusHistory` array
- [ ] Using `arrayUnion()` for history updates
- [ ] History entries include `changedBy` and `changedAt`

### 5. Security Check
- [ ] User input validated with Zod schema
- [ ] No sensitive data logged to console
- [ ] Auth checked before data mutations

### 6. Performance Check
- [ ] Queries include `limit()` for large collections
- [ ] Subscriptions cleaned up in `useEffect` return
- [ ] Heavy components use lazy loading if needed

### 7. Code Quality Check
- [ ] No `any` types (use proper TypeScript)
- [ ] Error handling with try/catch
- [ ] Loading and error states handled in UI

---

## üß™ QA Testing Process

### Test Categories

#### 1. Unit Testing
```bash
# Run all tests
npm run test

# Run tests in watch mode
npm run test:watch

# Run tests with coverage
npm run test:coverage
```

**What to Test:**
- Utility functions in `lib/`
- Zod validation schemas in `validate/`
- Custom hooks (mocked Firebase calls)
- Pure component logic

#### 2. Integration Testing
- Test form submissions end-to-end
- Verify Firestore read/write operations
- Test authentication flows
- Test role-based access control

#### 3. Manual Testing Checklist

**Before Every PR:**

| Category | Test Case | Status |
|----------|-----------|--------|
| **Auth** | Login with valid credentials | ‚¨ú |
| **Auth** | Login with invalid credentials shows error | ‚¨ú |
| **Auth** | Protected routes redirect to login | ‚¨ú |
| **Forms** | Form validation shows error messages | ‚¨ú |
| **Forms** | Successful submission shows success toast | ‚¨ú |
| **Forms** | Multi-step wizard navigation works | ‚¨ú |
| **Data** | List pages load and display data | ‚¨ú |
| **Data** | Create new record works | ‚¨ú |
| **Data** | Edit existing record works | ‚¨ú |
| **Data** | Delete record works with confirmation | ‚¨ú |
| **UI** | Responsive design (mobile/tablet/desktop) | ‚¨ú |
| **UI** | Dark mode displays correctly | ‚¨ú |
| **i18n** | Switch language works (EN/TH) | ‚¨ú |
| **i18n** | All text translates properly | ‚¨ú |

#### 4. Cross-Browser Testing
- ‚úÖ Chrome (latest)
- ‚úÖ Firefox (latest)
- ‚úÖ Safari (latest)
- ‚úÖ Edge (latest)
- ‚ö†Ô∏è Mobile browsers (iOS Safari, Android Chrome)

#### 5. Performance Testing
```bash
# Build and analyze bundle size
npm run build

# Check bundle analyzer output
```

**Performance Checklist:**
- [ ] First Contentful Paint < 2s
- [ ] Time to Interactive < 4s
- [ ] No console errors/warnings
- [ ] No memory leaks (check DevTools)
- [ ] Lighthouse score > 80

### Bug Reporting Template

When reporting bugs, include:

```markdown
## Bug Report

**Environment:**
- Browser: Chrome 120
- OS: Windows 11
- User Role: Admin

**Steps to Reproduce:**
1. Navigate to /admin/trucks
2. Click "Add New Truck"
3. Fill form and submit

**Expected Behavior:**
Truck should be saved and redirect to list

**Actual Behavior:**
Error toast shown: "Failed to save"

**Console Errors:**
```
FirebaseError: Missing or insufficient permissions
```

**Screenshots:**
[Attach if applicable]
```

### Test Environment Setup

**Development:**
```bash
npm run dev          # Local dev server
```

**Staging:**
```bash
npm run build        # Build for production
npm run start        # Start production server
```

**Firebase Emulators (Local Testing):**
```bash
firebase emulators:start   # Run Firestore/Auth locally
```

### Regression Testing

**After Major Changes, Test:**
1. ‚úÖ User authentication flow
2. ‚úÖ All CRUD operations for main entities
3. ‚úÖ Multi-tenancy data isolation
4. ‚úÖ Translation switching
5. ‚úÖ Role-based permissions

---

## üìù Change Log

| Date | Time | Change | Details |
|------|------|--------|---------|
| 2026-01-28 | - | Created .vibe-rules.md | Track project direction and decisions |
| 2026-01-28 | - | Added Compliance Standards | Standardize expiry thresholds (30/60 days, 2000/5000 km) |
| 2026-01-28 | - | Added Schema Validation Rules | Enforce dependent field validation in Zod |
| 2026-01-28 | - | UI Component Modularization | Split Truck Form into re-usable sections |
| 2026-01-28 | - | Added Responsibility UI | Added Footer to Compliance Cards |
| 2026-01-28 | - | Implemented Renewal Workflow | Created `/admin/trucks/[id]/renew` with Tax/Insurance tabs |
| 2026-01-28 | - | Renewal Form UI | Added form fields: Assignee, Provider, Expense, Status |
| 2026-01-28 | - | Insurance Renewal Enhancement | Added Policy ID, Policy Number, Coverage Type, Premium fields |
| 2026-01-28 | - | Truck Detail View Update | Updated `TruckPreviewClient.tsx` with renewal info |
| 2026-01-28 | - | Renewal Status Logic | Fixed renewal status "Completed" green badge |
| 2026-01-29 | 01:00 | Added Husky Pre-commit Hook | Auto-updates changelog on commit |
| 2026-01-29 | 01:10 | Implemented Maintenance Page | `/admin/trucks/[id]/maintenance` with service record form |
| 2026-01-29 | 01:20 | Link Maintenance button | Added button in TruckPreviewClient |
| 2026-01-29 | 01:35 | Added timestamp to changelog | Pre-commit hook now includes HH:MM |
| 2026-01-29 01:38:32 | Truck management updates | app/admin/trucks/new/components/TruckSteps/Step1Specs.tsx |
| 2026-01-29 01:41:46 | Renewal workflow updates | app/admin/trucks/[id]/renew/page.tsx |
| 2026-01-29 01:44:02 | Truck management updates | app/admin/trucks/page.tsx |
| 2026-01-29 | - | Added Routing & Hygiene Rules | Mandated Query Params for detail views, strict file cleanup |

---

## üöß Pending Decisions

_Add items here when direction needs to be decided:_

- [ ] **Mileage Data Source Strategy**
  - GPS (CarTrack): ¬±1,000 km accuracy, real-time
  - **Fuel Refill (Driver Entry)**: Accurate, captured during refueling
  - **Maintenance Entry**: Accurate, captured during service
  - **Plan**: Use latest fuel refill odometer as primary source, fallback to maintenance entry, GPS for real-time only
  - **Implementation**: Query latest fuel refill ‚Üí pre-fill maintenance form current mileage

---

## ‚úÖ Confirmed Patterns

_Add confirmed patterns here after decisions are made:_

- Subcontractor forms use multi-step wizard pattern
- Truck creation forms use multi-step wizard pattern

- Compliance warnings use 30-day / 2000km threshold (Red/Overdue), 60-day / 5000km threshold (Yellow/Incoming)
- Entity assignment (Tax => Admin, Service => Driver) is handled via `responsible` fields in schema
- **Compliance Cards** must include a "Responsibility Footer" to show the active owner
- **Truck Forms** are modularized into sections (`RegistrationSection`, `MaintenanceSection`, etc.) for reusability
- **Renewal Workflow** is implemented with Tax/Insurance tabs for compliance renewal
- **Insurance Renewal Enhancement** includes Policy ID, Policy Number, Coverage Type, Premium, Start/End Date, Notes fields
- **Truck Detail View Update** displays renewal and insurance information
- **Renewal Status Logic** shows "Completed" (green badge) when renewal is done
- **Husky Pre-commit Hook** blocks commits if `.vibe-rules.md` is not updated, ensures changelog is maintained
